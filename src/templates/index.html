<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lie Detector - Real-time Analysis</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #111827;
            color: white;
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        #videoStream {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .calibration-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .calibration-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900 text-white p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <h1 class="text-2xl font-bold">Lie Detector - Real-time Analysis</h1>
            </div>
            
            <div id="baselineInfo" class="hidden items-center gap-2 text-sm bg-green-900 bg-opacity-30 px-3 py-1 rounded-lg border border-green-600">
                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-green-400" id="baselineText">Baseline: -- BPM | --/min</span>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <!-- Sidebar -->
            <div class="col-span-3 bg-gray-800 rounded-lg p-4 space-y-2">
                <div class="text-sm space-y-2">
                    <div class="flex items-center gap-2 p-2 bg-gray-700 rounded cursor-pointer">
                        <div class="w-4 h-4 bg-gray-600 rounded"></div>
                        <span>Overview</span>
                    </div>
                    <div class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                        <div class="w-4 h-4 bg-gray-600 rounded"></div>
                        <span>Requirements</span>
                    </div>
                    <div class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                        <div class="w-4 h-4 bg-gray-600 rounded"></div>
                        <span>Installation</span>
                    </div>
                    <div class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                        <div class="w-4 h-4 bg-gray-600 rounded"></div>
                        <span>Usage</span>
                    </div>
                    <div class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                        <div class="w-4 h-4 bg-gray-600 rounded"></div>
                        <span>Algorithm Details</span>
                    </div>
                    <div class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                        <div class="w-4 h-4 bg-gray-600 rounded"></div>
                        <span>Calibration</span>
                    </div>
                    <div class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                        <div class="w-4 h-4 bg-gray-600 rounded"></div>
                        <span>Controls</span>
                    </div>
                    <div class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer">
                        <div class="w-4 h-4 bg-gray-600 rounded"></div>
                        <span>Limitations</span>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-span-6 space-y-4">
                <!-- Video Feed -->
                <div class="bg-gray-800 rounded-lg overflow-hidden relative aspect-video">
                    <div id="cameraContainer" class="w-full h-full flex items-center justify-center bg-gray-700">
                        <!-- Initial state -->
                        <div id="cameraInactive" class="text-center">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            <p class="text-gray-400 mb-2">Camera Feed Inactive</p>
                            <button onclick="startCalibration()" class="mt-4 px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition font-semibold">
                                Start Calibration
                            </button>
                        </div>

                        <!-- Video element (hidden initially) -->
                        <div id="videoContainer" class="video-container hidden">
                            <!-- MJPEG stream from backend - LOAD ONCE ONLY -->
                            <img id="videoStream" class="hidden" alt="Camera Feed" />
                            
                            <!-- Calibration overlay -->
                            <div id="calibrationOverlay" class="calibration-overlay hidden">
                                <div class="text-center bg-gray-800 p-6 rounded-lg border-2 border-blue-400 max-w-md">
                                    <svg class="w-12 h-12 mx-auto mb-3 text-blue-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    <p class="text-xl font-bold text-blue-400 mb-2">PHASE 1: CALIBRATION</p>
                                    <p class="text-sm text-gray-300 mb-4">Establishing baseline metrics...</p>
                                    <div class="w-full bg-gray-700 rounded-full h-3 mb-2">
                                        <div id="calibrationBar" class="bg-blue-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <p class="text-lg font-semibold text-blue-300"><span id="calibrationPercent">0</span>%</p>
                                    <p class="text-xs text-gray-400 mt-3">Time remaining: <span id="timeRemaining">60</span>s</p>
                                </div>
                            </div>
                            
                            <!-- BPM Display -->
                            <div id="bpmDisplay" class="absolute bottom-4 left-4 bg-gray-900 bg-opacity-80 rounded-lg p-3 flex items-center gap-2 text-green-400">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-xl font-bold" id="bpmValue">-- BPM</span>
                            </div>

                            <!-- Mini Graph -->
                            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-gray-900 bg-opacity-80 rounded-lg p-2">
                                <canvas id="waveformCanvas" width="200" height="50"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Bar & Detection Tells -->
                <div class="space-y-2">
                    <!-- Status Bar -->
                    <div id="statusBar" class="bg-gray-800 border border-gray-600 rounded-lg p-3 flex items-center justify-between">
                        <span class="text-sm" id="statusText">Status: Ready to calibrate</span>
                        <div id="analyzingDots" class="hidden gap-1">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                    
                    <!-- Calibration info -->
                    <div id="calibrationInfo" class="hidden bg-blue-900 bg-opacity-50 border border-blue-600 rounded-lg p-3">
                        <p class="text-sm text-blue-200 mb-2">Collecting baseline data:</p>
                        <ul class="text-xs text-blue-300 space-y-1 ml-4">
                            <li>â€¢ Heart rate variability</li>
                            <li>â€¢ Blink pattern frequency</li>
                            <li>â€¢ Facial emotion baseline</li>
                            <li>â€¢ Gaze stability metrics</li>
                            <li>â€¢ Hand-face contact frequency</li>
                        </ul>
                    </div>

                    <!-- Detection Tells Container -->
                    <div id="tellsContainer"></div>
                </div>
            </div>

            <!-- Right Sidebar - Analytics -->
            <div class="col-span-3 space-y-4">
                <!-- Blink Pattern -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-sm font-semibold mb-3">Blink Pattern</h3>
                    <div class="h-24 flex items-end gap-1" id="blinkChart"></div>
                    <div id="blinkBaseline" class="hidden mt-2 text-xs text-gray-400"></div>
                </div>

                <!-- Emotion Analysis -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center justify-between">
                        <span>Emotion (FER)</span>
                        <span id="emotionBadge" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-400">
                            neutral (0%)
                        </span>
                    </h3>
                    <div class="space-y-2" id="emotionBars"></div>
                    <div class="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
                        <p>Detection via FER (Facial Emotion Recognition) with MTCNN</p>
                    </div>
                </div>

                <!-- Hand-to-Face -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-sm font-semibold mb-3">Hand-to-Face Contact</h3>
                    <div class="flex items-center justify-center">
                        <div class="relative w-32 h-32">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="64" cy="64" r="56" stroke="#374151" stroke-width="8" fill="none"/>
                                <circle id="gestureCircle" cx="64" cy="64" r="56" stroke="#10b981" stroke-width="8" fill="none" 
                                        stroke-dasharray="0 352" class="transition-all duration-500"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <svg class="w-8 h-8 text-green-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"></path>
                                </svg>
                                <span class="text-xl font-bold" id="gestureScore">0</span>
                            </div>
                        </div>
                    </div>
                    <div id="gestureBaseline" class="hidden mt-2 text-xs text-gray-400 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        let isCalibrating = false;
        let calibrationProgress = 0;
        let baseline = {
            bpm: 0,
            blink_rate: 0,
            calibrated: false
        };
        let currentBpm = 0;
        let blinkData = Array(10).fill(0).map(() => Math.random() * 60 + 30);
        let emotionData = {
            angry: 0, disgust: 0, fear: 15, happy: 5,
            sad: 10, surprise: 5, neutral: 65
        };
        let waveformOffset = 0;
        let videoStreamLoaded = false;

        // Socket.IO events
        socket.on('connect', () => {
            console.log('âœ“ Connected to server');
        });

        socket.on('camera_started', () => {
            console.log('âœ“ Camera started - showing video feed');
            document.getElementById('cameraInactive').classList.add('hidden');
            document.getElementById('videoContainer').classList.remove('hidden');
            document.getElementById('calibrationOverlay').classList.remove('hidden');
            document.getElementById('calibrationInfo').classList.remove('hidden');
            
            // âœ… CRITICAL FIX: Load video stream ONCE only
            if (!videoStreamLoaded) {
                const videoStream = document.getElementById('videoStream');
                videoStream.src = '/video_feed';
                videoStream.classList.remove('hidden');
                videoStreamLoaded = true;
                
                console.log('âœ“ Video stream loaded from /video_feed');
                
                // Handle load errors
                videoStream.onerror = function() {
                    console.error('âœ— Video stream failed to load');
                    // Don't retry automatically to avoid connection spam
                };
            }
            
            isCalibrating = true;
            
            // Update status
            document.getElementById('statusBar').className = 'bg-blue-900 border border-blue-600 rounded-lg p-3 flex items-center justify-between';
            document.getElementById('statusText').textContent = 'Status: PHASE 1 - Calibrating... (0%)';
            
            startWaveform();
        });

        socket.on('calibration_progress', (data) => {
            calibrationProgress = data.progress;
            const percent = Math.round(calibrationProgress);
            const remaining = Math.round(data.remaining);
            
            document.getElementById('calibrationBar').style.width = percent + '%';
            document.getElementById('calibrationPercent').textContent = percent;
            document.getElementById('timeRemaining').textContent = remaining;
            document.getElementById('statusText').textContent = `Status: PHASE 1 - Calibrating... (${percent}%)`;
        });

        socket.on('calibration_complete', (data) => {
            console.log('âœ“ Calibration complete:', data);
            isCalibrating = false;
            
            // Set baseline from server
            baseline = data.baseline;
            baseline.calibrated = true;
            
            // Hide calibration overlay
            document.getElementById('calibrationOverlay').classList.add('hidden');
            document.getElementById('calibrationInfo').classList.add('hidden');
            
            // Show baseline info
            document.getElementById('baselineInfo').classList.remove('hidden');
            document.getElementById('baselineInfo').classList.add('flex');
            document.getElementById('baselineText').textContent = 
                `Baseline: ${baseline.bpm.toFixed(1)} BPM | ${baseline.blink_rate.toFixed(1)}/min`;
            
            // Update status
            document.getElementById('statusBar').className = 'bg-green-900 border border-green-600 rounded-lg p-3 flex items-center justify-between';
            document.getElementById('statusText').textContent = 'Status: PHASE 2 - Interrogation Mode Active';
            document.getElementById('analyzingDots').classList.remove('hidden');
            document.getElementById('analyzingDots').classList.add('flex');
            
            // Show baselines in charts
            document.getElementById('blinkBaseline').classList.remove('hidden');
            document.getElementById('blinkBaseline').textContent = `Baseline: ${baseline.blink_rate.toFixed(1)}/min`;
            document.getElementById('gestureBaseline').classList.remove('hidden');
        });

        socket.on('analysis_data', (data) => {
            if (data.bpm) {
                currentBpm = data.bpm;
                const delta = Math.abs(currentBpm - baseline.bpm);
                const percentChange = ((currentBpm - baseline.bpm) / baseline.bpm * 100).toFixed(0);
                
                const bpmDisplay = document.getElementById('bpmDisplay');
                bpmDisplay.className = 'absolute bottom-4 left-4 bg-gray-900 bg-opacity-80 rounded-lg p-3 flex items-center gap-2';
                
                if (isCalibrating) {
                    bpmDisplay.classList.add('text-blue-400');
                    document.getElementById('bpmValue').textContent = `${currentBpm.toFixed(1)} BPM (Collecting...)`;
                } else {
                    if (delta < 5) bpmDisplay.classList.add('text-green-400');
                    else if (delta < 10) bpmDisplay.classList.add('text-yellow-400');
                    else bpmDisplay.classList.add('text-red-400');
                    
                    if (baseline.bpm > 0) {
                        document.getElementById('bpmValue').textContent = `${currentBpm.toFixed(1)} BPM (${percentChange > 0 ? '+' : ''}${percentChange}%)`;
                    } else {
                        document.getElementById('bpmValue').textContent = `${currentBpm.toFixed(1)} BPM`;
                    }
                }
            }
            
            // Handle alerts (only in interrogation mode)
            if (data.alert && !isCalibrating) {
                addTell(`ðŸš¨ ALERT: ${data.alert.indicators.join(', ')} (${(data.alert.confidence * 100).toFixed(0)}%)`);
            }
        });

        // Start calibration
        function startCalibration() {
            console.log('ðŸŽ¬ Starting calibration...');
            isCalibrating = true;
            calibrationProgress = 0;
            socket.emit('start_camera');
        }

        function startWaveform() {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            
            function drawWaveform() {
                ctx.clearRect(0, 0, 200, 50);
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for (let i = 0; i < 50; i++) {
                    const x = i * 4;
                    const y = 25 + Math.sin((i * 0.3) + waveformOffset) * 15;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                
                ctx.stroke();
                waveformOffset += 0.1;
                
                requestAnimationFrame(drawWaveform);
            }
            
            drawWaveform();
        }

        // Update blink chart
        function updateBlinkChart() {
            blinkData.shift();
            blinkData.push(Math.random() * 60 + 30);
            
            const chart = document.getElementById('blinkChart');
            chart.innerHTML = blinkData.map(value => 
                `<div class="flex-1 bg-blue-500 rounded-t transition-all duration-300" style="height: ${value}%"></div>`
            ).join('');
        }

        // Update emotion chart
        function updateEmotionChart() {
            const emotions = ['angry', 'disgust', 'fear', 'happy', 'sad', 'surprise', 'neutral'];
            const colors = {
                angry: '#ef4444', disgust: '#84cc16', fear: '#8b5cf6',
                happy: '#fbbf24', sad: '#3b82f6', surprise: '#ec4899', neutral: '#6b7280'
            };
            
            emotions.forEach(emotion => {
                emotionData[emotion] = Math.max(0, Math.min(100, emotionData[emotion] + (Math.random() - 0.5) * 15));
            });
            
            const total = Object.values(emotionData).reduce((a, b) => a + b, 0);
            emotions.forEach(emotion => {
                emotionData[emotion] = (emotionData[emotion] / total) * 100;
            });
            
            let maxEmotion = 'neutral';
            let maxValue = 0;
            emotions.forEach(emotion => {
                if (emotionData[emotion] > maxValue) {
                    maxValue = emotionData[emotion];
                    maxEmotion = emotion;
                }
            });
            
            const badge = document.getElementById('emotionBadge');
            badge.textContent = `${maxEmotion} (${Math.round(maxValue)}%)`;
            badge.style.backgroundColor = colors[maxEmotion] + '33';
            badge.style.color = colors[maxEmotion];
            
            const barsContainer = document.getElementById('emotionBars');
            barsContainer.innerHTML = emotions.map(emotion => `
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="capitalize">${emotion}</span>
                        <span class="text-gray-400">${emotionData[emotion].toFixed(1)}%</span>
                    </div>
                    <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500" 
                             style="width: ${emotionData[emotion]}%; background-color: ${colors[emotion]}"></div>
                    </div>
                </div>
            `).join('');
        }

        // Update metrics
        function updateMetrics() {
            if (isCalibrating) return;
            
            const gestureScore = Math.max(60, Math.min(100, Math.random() * 40 + 60));
            document.getElementById('gestureScore').textContent = Math.round(gestureScore);
            document.getElementById('gestureCircle').setAttribute('stroke-dasharray', `${gestureScore * 3.52} 352`);
            
            // Random tells (only in interrogation mode)
            if (!isCalibrating && Math.random() > 0.92) {
                const tells = [
                    'Heart rate increase detected',
                    'Increased blinking pattern',
                    'Gaze shift detected',
                    'Lip compression observed'
                ];
                addTell(tells[Math.floor(Math.random() * tells.length)]);
            }
        }

        function addTell(message) {
            const container = document.getElementById('tellsContainer');
            const id = Date.now();
            
            const tellDiv = document.createElement('div');
            tellDiv.id = `tell-${id}`;
            tellDiv.className = 'bg-yellow-900 bg-opacity-50 border border-yellow-600 rounded-lg p-2 flex items-center justify-between animate-pulse';
            tellDiv.innerHTML = `
                <span class="text-sm text-yellow-200">${message}</span>
                <span class="text-xs text-yellow-400" id="ttl-${id}">10s</span>
            `;
            
            container.appendChild(tellDiv);
            
            let ttl = 10;
            const interval = setInterval(() => {
                ttl--;
                const ttlSpan = document.getElementById(`ttl-${id}`);
                if (ttlSpan) ttlSpan.textContent = `${ttl}s`;
                
                if (ttl <= 0) {
                    clearInterval(interval);
                    const el = document.getElementById(`tell-${id}`);
                    if (el) el.remove();
                }
            }, 1000);
        }

        // Start periodic updates
        setInterval(updateBlinkChart, 2000);
        setInterval(updateEmotionChart, 2000);
        setInterval(updateMetrics, 2000);
        
        // Initial render
        updateBlinkChart();
        updateEmotionChart();
    </script>
</body>
</html>